<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../../css/public.css" media="all">
    <link rel="stylesheet" href="../../css/lightboard/txBoard.css" media="all">
    <link rel="stylesheet" href="../../css/lightboard/46.css" media="all">
    <style>
        body {
            background-color: #ffffff;
        }

        .ant-col-mistake {
            margin-top: -18px;
        }
    </style>
</head>
<body style="background-color: #f5f6fa;">
<div class="layui-form layuimini-form">

    <!-- 块头摘要   -->
    <div class="single-pannel bg-sm-white">
        <div class="block-info-container">
            <div class="ant-card ant-card-bordered">
                <div class="ant-card-head">
                    <div class="ant-card-head-wrapper">
                        <div class="ant-card-head-title">块头摘要</div>
                    </div>
                </div>
                <div class="ant-card-body">
                    <div class="content">
                        <div class="split-content">
                            <div class="ant-row">
                                <div class="ant-col ant-col-10"><span>区块高度</span></div>
                                <div class="ant-col ant-col-14 ant-col-mistake">
                                    <div class="block-height-icon"><span role="img" tabindex="-1" class="anticon"
                                                                         style="font-size: 8px; color: rgb(123, 130, 147); transform: rotate(180deg);"><svg
                                            width="1em" height="1em" fill="currentColor" aria-hidden="true"
                                            focusable="false" class=""><use
                                            xlink:href="#icon-next"></use></svg></span><span id="block-height" class="block-height">628728</span><span role="img" tabindex="-1"
                                                                                    class="anticon"
                                                                                    style="font-size: 8px; color: rgb(123, 130, 147);"><svg
                                            width="1em" height="1em" fill="currentColor" aria-hidden="true"
                                            focusable="false" class=""><use xlink:href="#icon-next"></use></svg></span>
                                    </div>
                                </div>
                            </div>
                            <div class="ant-row">
                                <div class="ant-col ant-col-6"><span class="color-7B8293">时间</span></div>
                                <div class="ant-col ant-col-18 ellipsis  ant-col-mistake" style="text-align: right;">
                                    <span id="block-data"
                                            class="value">0 </span>(
                                    <time class="" datetime="1588503974000" timeago-id="1309" id="block-diffDate">0 分钟前</time>
                                    )
                                </div>
                            </div>
                            <div class="ant-row">
                                <div class="ant-col ant-col-8"><span>本区块Hash</span></div>
                                <div class="ant-col ant-col-16 merkleroot"  id="block-hash"
                                     style="    color: #0a134e;text-decoration: none">
                                    0
                                </div>
                            </div>
                        </div>
                        <div class="split-line okg-sm-hide okg-sm-hide"></div>
                        <div class="split-content">
                            <div class="ant-row">
                                <div class="ant-col ant-col-10"><span>难度</span></div>
                                <div id="block-difficultyTarget"
                                        class="ant-col ant-col-14  ant-col-mistake">3</div>
                            </div>
                            <div class="ant-row">
                                <div class="ant-col ant-col-10"><span>Nonce</span></div>
                                <div class="ant-col ant-col-14  ant-col-mistake" id="block-nonce">0x88b82fb7</div>
                            </div>
                            <div class="ant-row">
                                <div class="ant-col ant-col-10"><span>交易数量</span></div>
                                <div class="ant-col ant-col-14  ant-col-mistake">426</div>
                            </div>
                            <div class="ant-row">
                                <div class="ant-col ant-col-8"><span>前一个块Hash</span></div>
                                <div class="ant-col ant-col-16 merkleroot"
                                     style="    color: #337ab7;text-decoration: none" id="block-prevBlockHash">
                                    0
                                </div>
                            </div>
                        </div>
                        <div class="split-line okg-md-hide okg-sm-hide"></div>
                        <div class="split-content okg-md-hide okg-sm-hide">
                            <div class="ant-row">
                                <div class="ant-col ant-col-10"><span>确认数</span></div>
                                <div class="ant-col ant-col-14  ant-col-mistake">0</div>
                            </div>
                            <div class="ant-row">
                                <div class="ant-col ant-col-10"><span>时间戳</span></div>
                                <div id="block-timestamp"
                                        class="ant-col ant-col-14  ant-col-mistake">0</div>
                            </div>
                            <div class="ant-row">
                                <div class="ant-col ant-col-10"><span>矿工费</span></div>
                                <div class="ant-col ant-col-14  ant-col-mistake"><span class=""><span
                                        class="color-1F2533">0.</span><span
                                        class="color-7B8293">8702 LDC</span></span></div>
                            </div>
                            <div class="ant-row">
                                <div class="ant-col ant-col-8"><span>MerkleRoot</span></div>
                                <div class="ant-col ant-col-16 merkleroot" id="block-merkleRoot"
                                     style="    color: #2e3134;text-decoration: none">
                                    0
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 交易详情   -->
    <div class="single-pannel bg-sm-white">
        <div class="bottom-content-container" style="margin-top: 20px;">
            <div class="ant-card block-statistic-card ant-card-bordered">
                <div class="ant-card-body">
                    <ul class="ant-menu trade-statistic-menu trade-and-dress-card ant-menu-light ant-menu-root ant-menu-horizontal"
                        role="menu">
                        <li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu"
                            role="menuitem" style="display: none;">
                            <div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true">
                                <span>···</span><i class="ant-menu-submenu-arrow"></i></div>
                        </li>
                        <li class="ant-menu-item ant-menu-item-only-child ant-menu-item-selected" role="menuitem">交易
                        </li>
                        <li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu"
                            role="menuitem" style="display: none;">
                            <div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true">
                                <span>···</span><i class="ant-menu-submenu-arrow"></i></div>
                        </li>

                        <li class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu"
                            role="menuitem" style="visibility: hidden; position: absolute; display: none;">
                            <div class="ant-menu-submenu-title" aria-expanded="false" aria-haspopup="true">
                                <span>···</span><i class="ant-menu-submenu-arrow"></i></div>
                        </li>
                    </ul>
                    <ul class="address-info-trade-component">
                        <li class="block-info-trade-item" style="padding-bottom: 2%;">
                            <div class="top">哈希 <a class="ae-family ellipsis"
                                          id="tx0-hash"      href="/btc/tx/bd1166e9e8f421a6d3e20b11d4ffa014ed21d706ef022b9374b787d93a328931">0</a>
                                <div class="items font-12 font-lg-14">
                                    <span class="time color-7B8293">
                                    <span id="tx0-timestamp">0</span>
                                        (<span id="tx0-date">0</span>)
                                    </span>
                                </div>
                            </div>
                            <div class="address-details">
                                <div class="center font-12 font-lg-14">
                                    <div class="left-items">
                                        <div class="ant-row input-row">
                                            <div class="ant-col input-address ellipsis"><span class="coinbase-tag">Coinbase</span>
                                            </div>
                                            <div class="ant-col input-balance"></div>
                                        </div>
                                    </div>
                                    <div class="mid-items"><span role="img" theme="filled" class="anticon"
                                                                 style="font-size: 20px;"><svg width="1em" height="1em"
                                                                                               fill="currentColor"
                                                                                               aria-hidden="true"
                                                                                               focusable="false"
                                                                                               class=""><use
                                            xlink:href="#icon-arrow-gray"></use></svg></span></div>
                                    <div class="right-items">
                                        <div class="ant-row output-row">
                                        </div>
                                    </div>
                                </div>

                                <div style="margin: 1% 1% 3%;">
                                    <h3>收款人</h3>
                                    <div style="word-wrap:break-word;word-break:break-all; " id="tx0-publicKey">
                                        0
                                    </div>
                                </div>

                                <div class="ant-card scripts-container ant-card-bordered">
                                    <div class="ant-card-head">
                                        <div class="ant-card-head-wrapper">
                                            <div class="ant-card-head-title" style="    padding-left: 2%;">输入脚本</div>
                                            <div class="ant-card-extra">
                                                <div class="drop-down drop-rotating"><span role="img" class="anticon"><svg
                                                        width="1em" height="1em" fill="currentColor" aria-hidden="true"
                                                        focusable="false" class=""><use
                                                        xlink:href="#icon-dropdown_api1"></use></svg></span></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ant-card-body">
                                        <div class="scripts-container-box" style="height: auto;">
                                            <div class="script-list">
                                                <ul class="script-list-item">
                                                    <li class="script-data" style="    padding-left: 2%;">
                                                        <div style="word-break: break-all;font-size: 15px;padding-top: 1%;" id="tx0-scriptString">
                                                            0
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>


</div>
<script src="../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="../../js/base64.js" charset="utf-8"></script>
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script>

    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]); return null;
    }
    function formatterTime(timestamp) {
        // 传入时间戳
        let date =  new Date(timestamp);
        let year = date.getFullYear();
        let getMonth =formatZero(date.getMonth()+1);
        let getDay = formatZero(date.getDate());
        let getHours = formatZero(date.getHours());
        let getMinutes = formatZero(date.getMinutes());
        let getSeconds = formatZero(date.getSeconds());
        return year+"-"+getMonth+"-"+getDay+" "+getHours+":"+getMinutes+":"+getSeconds;
    }
    function formatZero(num){
        return num < 10 ? ('0' + num) : num;
    }

    function timesFun (timesData) {
        //如果时间格式是正确的，那下面这一步转化时间格式就可以不用了
        var dateBegin = new Date(timesData.replace(/-/g, "/"));//将-转化为/，使用new Date
        var dateEnd = new Date();//获取当前时间
        var dateDiff = dateEnd.getTime() - dateBegin.getTime();//时间差的毫秒数
        var dayDiff = Math.floor(dateDiff / (24 * 3600 * 1000));//计算出相差天数
        var leave1 = dateDiff % (24 * 3600 * 1000)    //计算天数后剩余的毫秒数
        var hours = Math.floor(leave1 / (3600 * 1000))//计算出小时数
        //计算相差分钟数
        var leave2 = leave1 % (3600 * 1000)    //计算小时数后剩余的毫秒数
        var minutes = Math.floor(leave2 / (60 * 1000))//计算相差分钟数
        //计算相差秒数
        var leave3 = leave2 % (60 * 1000)      //计算分钟数后剩余的毫秒数
        var seconds = Math.round(leave3 / 1000);
        var timesString = '';

        if (dayDiff != 0) {
            timesString = dayDiff + '天前';
        } else if (dayDiff == 0 && hours != 0) {
            timesString = hours + '小时前';
        } else if (dayDiff == 0 && hours == 0) {
            timesString = minutes + '分钟前';
        }

        return {
            timesString: timesString
        }
    }

    let Base64 = {

        // private property
        _keyStr: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="

        // public method for encoding
        , encode: function (input) {
            var output = "";
            var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
            var i = 0;

            input = Base64._utf8_encode(input);

            while (i < input.length) {
                chr1 = input.charCodeAt(i++);
                chr2 = input.charCodeAt(i++);
                chr3 = input.charCodeAt(i++);

                enc1 = chr1 >> 2;
                enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
                enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
                enc4 = chr3 & 63;

                if (isNaN(chr2)) {
                    enc3 = enc4 = 64;
                }
                else if (isNaN(chr3)) {
                    enc4 = 64;
                }

                output = output +
                    this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +
                    this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);
            } // Whend

            return output;
        } // End Function encode


        // public method for decoding
        , decode: function (input) {
            var output = "";
            var chr1, chr2, chr3;
            var enc1, enc2, enc3, enc4;
            var i = 0;

            input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");
            while (i < input.length) {
                enc1 = this._keyStr.indexOf(input.charAt(i++));
                enc2 = this._keyStr.indexOf(input.charAt(i++));
                enc3 = this._keyStr.indexOf(input.charAt(i++));
                enc4 = this._keyStr.indexOf(input.charAt(i++));

                chr1 = (enc1 << 2) | (enc2 >> 4);
                chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
                chr3 = ((enc3 & 3) << 6) | enc4;

                output = output + String.fromCharCode(chr1);

                if (enc3 != 64) {
                    output = output + String.fromCharCode(chr2);
                }

                if (enc4 != 64) {
                    output = output + String.fromCharCode(chr3);
                }

            } // Whend

            output = Base64._utf8_decode(output);

            return output;
        } // End Function decode


        // private method for UTF-8 encoding
        , _utf8_encode: function (string) {
            var utftext = "";
            string = string.replace(/\r\n/g, "\n");

            for (var n = 0; n < string.length; n++) {
                var c = string.charCodeAt(n);

                if (c < 128) {
                    utftext += String.fromCharCode(c);
                }
                else if ((c > 127) && (c < 2048)) {
                    utftext += String.fromCharCode((c >> 6) | 192);
                    utftext += String.fromCharCode((c & 63) | 128);
                }
                else {
                    utftext += String.fromCharCode((c >> 12) | 224);
                    utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                    utftext += String.fromCharCode((c & 63) | 128);
                }

            } // Next n

            return utftext;
        } // End Function _utf8_encode

        // private method for UTF-8 decoding
        , _utf8_decode: function (utftext) {
            var string = "";
            var i = 0;
            var c, c1, c2, c3;
            c = c1 = c2 = 0;

            while (i < utftext.length) {
                c = utftext.charCodeAt(i);

                if (c < 128) {
                    string += String.fromCharCode(c);
                    i++;
                }
                else if ((c > 191) && (c < 224)) {
                    c2 = utftext.charCodeAt(i + 1);
                    string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
                    i += 2;
                }
                else {
                    c2 = utftext.charCodeAt(i + 1);
                    c3 = utftext.charCodeAt(i + 2);
                    string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
                    i += 3;
                }

            } // Whend

            return string;
        } // End Function _utf8_decode

    }

    $(function () {
        //加载区块数据
        let height = getQueryString("height");
        let hash = getQueryString("hash");
        let difficultyTarget = getQueryString("difficultyTarget");
        let timestamp = getQueryString("timestamp");
        let merkleRoot = getQueryString("merkleRoot");
        let nonce = getQueryString("nonce");
        let prevBlockHash = getQueryString("prevBlockHash");
        let data = formatterTime(parseInt(timestamp));
        let diffDate = timesFun(data);
        let transactions = getQueryString("transactions");
        console.log(decodeURIComponent(transactions));
        transactions = JSON.parse( decodeURIComponent(transactions) );
        let coinbase = transactions[0];
        console.log(coinbase);

        let coinbaseTimestamp=  coinbase.timestamp;
        let tx0Date = formatterTime(parseInt(coinbaseTimestamp));

        $("#tx0-publicKey").text(coinbase.publicKey);
        $("#tx0-hash").text(coinbase.hash);
        $("#tx0-scriptString").text(Base64.decode(coinbase.scriptBytes));
        $("#tx0-timestamp").text(coinbaseTimestamp);
        $("#tx0-date").text(tx0Date);

        $("#block-height").text(height);
        $("#block-hash").text(hash);
        $("#block-difficultyTarget").text(difficultyTarget);
        $("#block-timestamp").text(timestamp);
        $("#block-data").text(data);
        $("#block-merkleRoot").text(merkleRoot);
        $("#block-nonce").text(nonce);
        $("#block-prevBlockHash").text(prevBlockHash);
        $("#block-diffDate").text(diffDate.timesString);

        $.get('../../api/lightboard/block.json',{}
            , function (ret) {
                //解析ret
                ret = eval("(" + ret + ")");

                if (ret['code'] === 0) {
                    alert("修改成功！");
                    //先得到当前iframe层的索引
                    var index = parent.layer
                        .getFrameIndex(window.name);
                    //再执行关闭
                    parent.layer.close(index);
                    parent.location.reload();
                }
                else {
                    var errorInfo = ret['errorInfo'];
                    alert("修改失败！" + errorInfo);
                }

                //关闭所有弹窗
                layer.closeAll();

            });

    });
</script>
</body>
</html>